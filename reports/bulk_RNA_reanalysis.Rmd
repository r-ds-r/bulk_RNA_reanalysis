---
title: "R Notebook"
output: html_notebook
---

```{r start-up}

# === clearing workspace ===

rm(list = ls())

# === loading libraries ===

library(biomaRt)
library(readxl)
library(ggplot2)
library(pheatmap)
library(dplyr)
library(limma)
library(RColorBrewer)
library(viridis)
library(here)
library(openxlsx)

# === loading utilities scripts ===

script_files <- sort(list.files(
  here("R"),
  pattern = "\\.R$",
  full.names = TRUE
))

message("Sourcing scripts: ")
for (f in script_files) {
  source(f)
  message(" âœ“ ", basename(f))
}

# === remove temporary variables ===
rm(f, script_files)

```

#### FILES CONTAINED IN [ here("R") ] FOLDER

```{r 01_paths}
# === OUTPUT FOLDER ===
DATA_PROCESSED <- here("data", "processed")
if (!dir.exists(DATA_PROCESSED)) {
  response <- readline(prompt = paste0("Processed data directory not found at: ", DATA_PROCESSED, "\nCreate it? (y/n): "))
  if (tolower(response) == "y") {
    dir.create(DATA_PROCESSED, recursive = TRUE)
    message("Created processed data directory: ", DATA_PROCESSED)
  } else {
    stop("Processed data directory does not exist. Please create it manually or choose 'y' to create automatically.")
  }
}

# === R SCRIPTS ===
SCRIPTS_DIR <- here("R")
if (!dir.exists(SCRIPTS)) {
  message("R scripts not found at: ", SCRIPTS_DIR)
  SCRIPTS <- file.choose()
  message("Selected folder: ", SCRIPTS_DIR)
}

# === FIGURES FOLDER ===
FIGURES_DIR <- here("figures")
if (!dir.exists(FIGURES_DIR)) {
  response <- readline(prompt = paste0("Figures directory not found at: ", FIGURES_DIR, "\nCreate it? (y/n): "))
  if (tolower(response) == "y") {
    dir.create(FIGURES_DIR, recursive = TRUE)
    message("Created figures directory: ", FIGURES_DIR)
  } else {
    stop("Figures directory does not exist. Please create it manually or choose 'y' to create automatically.")
  }
}

```

```{r 02_functions}
extract_genes_from_results <- function(results, gene_list, list_name = "") {
  stats <- results[rownames(results) %in% gene_list, ]
  
  if(nrow(stats) > 0) {
    cat("\n=== ", list_name, " ===\n")
    cat("Total genes found:", nrow(stats), "\n")
    cat("Significant (padj < 0.05):", sum(stats$adj.P.Val < 0.05, na.rm = TRUE), "\n")
    cat("Upregulated:", sum(stats$adj.P.Val < 0.05 & stats$logFC > 0, na.rm = TRUE), "\n")
    cat("Downregulated:", sum(stats$adj.P.Val < 0.05 & stats$logFC < 0, na.rm = TRUE), "\n")
  }
  
  return(stats)
}

## === SAVING EXCEL FILES OF PROCESSED DATA ===
save_xlsx <- function(df, filename_base) {
  
  # Full path to workbook
  wb_file <- file.path(DATA_PROCESSED, filename_base)
  
  # Generate timestamp for the sheet name
  timestamp <- format(Sys.time(), "%Y%m%d_%H%M%S")
  
  # Load workbook if exists, else create new
  if (file.exists(wb_file)) {
    wb <- loadWorkbook(wb_file)
  } else {
    wb <- createWorkbook()
  }
  
  # Add new sheet with just time stamp as name
  addWorksheet(wb, timestamp)
  writeData(wb, sheet = timestamp, x = df)
  
  # Save workbook (overwrite = TRUE updates existing file)
  saveWorkbook(wb, wb_file, overwrite = TRUE)
  
  message("Saved sheet '", timestamp, "' to workbook '", wb_file, "'")
}

# === SAVING PNG VERSIONS OF PLOTS ===
save_png <- function(filename, width = FIG_WIDTH, height = FIG_HEIGHT, res = FIG_RES, units = FIG_UNITS) {
  filepath <- file.path(FIGURES_DIR, filename)
  png(filepath, width = width, height = height, units = units, res = res)
  message("Saving figure to:", filepath)
}
```

```{r 03_figures}

# Define custom colors for conditions
annotation_colors <- list(
  condition = c(sham = "#2B5B3F", SNL = "#C4501B", SNI = "#C4501B")
)

# Define high definition figure size
FIG_WIDTH  <- 3000
FIG_HEIGHT <- 2400
FIG_RES    <- 300
FIG_UNITS  <- "px"

```

#### Loading raw data

```{r}

# Input of counts data

DATA_RAW <- here("data", "raw", "OMIX008150-01.xls")
if (!file.exists(DATA_RAW)) {
  message("Counts file not found: ", DATA_RAW)
  DATA_RAW <- file.choose()
  message("Selected file: ", DATA_RAW)
}

# Connect to Ensembl's mouse database
mart <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")


```

#### Changing data frame row names

```{r}

# Load your dataset
DRGcounts <- read_excel(DATA_RAW, sheet = 1)
SCcounts <- read_excel(DATA_RAW, sheet = 2)

# Convert Ensembl IDs to row names

SCcounts <- as.data.frame(SCcounts)
rownames(SCcounts) <- SCcounts[,1]
SCcounts <- SCcounts[,-1]
DRGcounts <- as.data.frame(DRGcounts)
rownames(DRGcounts) <- DRGcounts[,1]
DRGcounts <- DRGcounts[,-1]

```

#### Converting ENSEMBL IDs to conventional gene names

```{r}
# Convert Ensembl IDs to gene symbols
SCgenes <- getBM(attributes = c("ensembl_gene_id", "mgi_symbol"),
               filters = "ensembl_gene_id",
               values = rownames(SCcounts),
               mart = mart)

# Merge gene symbols with count data
SCcounts <- merge(SCgenes, SCcounts, by.x = "ensembl_gene_id", by.y = "row.names", all.y = TRUE)

# Remove duplicates
SCcounts <- SCcounts[!duplicated(SCcounts$mgi_symbol), ]

# Remove rows with missing gene symbols
SCcounts <- SCcounts[!is.na(SCcounts$mgi_symbol), ]

# make gene name the row name
rownames(SCcounts) <- SCcounts$mgi_symbol 

# make list of matching ensembl IDs and gene symbols
SCgene_info <- data.frame(
  gene_symbol = SCcounts$mgi_symbol,
  ensembl_id = SCcounts$ensembl_gene_id,
  row.names = SCcounts$mgi_symbol
)

# Remove the redundant columns
SCcounts <- SCcounts[, !colnames(SCcounts) %in% c("mgi_symbol", "ensembl_gene_id")]

# Create dataframe of sample condition
SCsample_condition <- data.frame(
  row.names = colnames(SCcounts), 
  condition = ifelse(grepl("sham", colnames(SCcounts)), "sham", "SNL") 
)

## Repeat for DRG
DRGgenes <- getBM(attributes = c("ensembl_gene_id", "mgi_symbol"),
               filters = "ensembl_gene_id",
               values = rownames(DRGcounts),
               mart = mart)
DRGcounts <- merge(DRGgenes, DRGcounts, by.x = "ensembl_gene_id", by.y = "row.names", all.y = TRUE)
DRGcounts <- DRGcounts[!duplicated(DRGcounts$mgi_symbol), ]
DRGcounts <- DRGcounts[!is.na(DRGcounts$mgi_symbol), ]
rownames(DRGcounts) <- DRGcounts$mgi_symbol 
DRGgene_info <- data.frame(
  gene_symbol = DRGcounts$mgi_symbol,
  ensembl_id = DRGcounts$ensembl_gene_id,
  row.names = DRGcounts$mgi_symbol
)
DRGcounts <- DRGcounts[, !colnames(DRGcounts) %in% c("mgi_symbol", "ensembl_gene_id")]
DRGsample_condition <- data.frame(
  row.names = colnames(DRGcounts), 
  condition = ifelse(grepl("Sham", colnames(DRGcounts)), "sham", "SNI") 
)


```

#### Converting FPKM reads to log2, Stats analysis

```{r}
# Log-transform FPKM (add pseudocount to avoid log(0))
SClog_fpkm <- log2(SCcounts + 1)

# Filter low-expressed genes
SCkeep <- rowSums(SClog_fpkm > 1) >= 3  # Expressed in at least 3 samples
SClog_fpkm_filtered <- SClog_fpkm[SCkeep, ]

# Design matrix
SCdesign <- model.matrix(~0 + condition, data = SCsample_condition)
colnames(SCdesign) <- c("sham", "SNL")

# Fit linear model (WITHOUT voom, since data is already normalized)
SCfit <- lmFit(SClog_fpkm_filtered, SCdesign)

# Make contrasts
SCcontrast <- makeContrasts(SNL_vs_sham = SNL - sham, levels = SCdesign)

# Empirical Bayes
SCfit2 <- contrasts.fit(SCfit, SCcontrast)
SCfit2 <- eBayes(SCfit2)

# Results
SCresults <- topTable(SCfit2, coef = "SNL_vs_sham", n = Inf, sort.by = "P")
summary(decideTests(SCfit2, p.value = 0.05))
head(SCresults, 20)

# Save results to file
save_xlsx(SCresults, "SC_DE_results_SNL_vs_sham.xlsx")

## REPEAT FOR DRG

DRGlog_fpkm <- log2(DRGcounts + 1)
DRGkeep <- rowSums(DRGlog_fpkm > 1) >= 3  # Expressed in at least 3 samples
DRGlog_fpkm_filtered <- DRGlog_fpkm[DRGkeep, ]
cat("Genes before filtering:", nrow(DRGlog_fpkm), "\n")
cat("Genes after filtering:", nrow(DRGlog_fpkm_filtered), "\n")
DRGdesign <- model.matrix(~0 + condition, data = DRGsample_condition)
colnames(DRGdesign) <- c("sham", "SNI")
DRGfit <- lmFit(DRGlog_fpkm_filtered, DRGdesign)
DRGcontrast <- makeContrasts(SNI_vs_sham = SNI - sham, levels = DRGdesign)
DRGfit2 <- contrasts.fit(DRGfit, DRGcontrast)
DRGfit2 <- eBayes(DRGfit2)
DRGresults <- topTable(DRGfit2, coef = "SNI_vs_sham", number = Inf, sort.by = "P")
summary(decideTests(DRGfit2, p.value = 0.05))
head(DRGresults, 20)

# Optional: Save results to file
save_xlsx(DRGresults, "DRG_SNI_vs_sham_results.xlsx")


```

#### Quality Control

```{r}

# ===== SPINAL CORD =====

# Sample correlation heatmap
SC_sample_cor <- cor(SClog_fpkm_filtered, method = "pearson")

save_png("SC_sample_correlation.png")
pheatmap(
  SC_sample_cor,
  color = colorRampPalette(rev(brewer.pal(11, "RdBu")))(100),
  annotation_col = SCsample_condition,
  annotation_row = SCsample_condition,
  annotation_colors = annotation_colors,
  display_numbers = TRUE,
  number_format = "%.2f",
  fontsize_number = 10,
  main = "SC: Sample Correlation (Pearson)",
  clustering_distance_rows = "euclidean",
  clustering_distance_cols = "euclidean"
)
dev.off()

# PCA analysis
SC_pca <- prcomp(t(SClog_fpkm_filtered), scale. = TRUE)
SC_pca_data <- data.frame(
  PC1 = SC_pca$x[,1],
  PC2 = SC_pca$x[,2],
  condition = SCsample_condition$condition,
  Sample = rownames(SC_pca$x)
)

# Calculate variance explained
SC_var_explained <- round(100 * SC_pca$sdev^2 / sum(SC_pca$sdev^2), 1)

# PCA plot
save_png("SC_PCA.png")
ggplot(SC_pca_data, aes(x = PC1, y = PC2, color = condition, label = Sample)) +
  geom_point(size = 4) +
  geom_text(vjust = -1, size = 3) +
  scale_color_manual(values = annotation_colors$condition) +
  labs(
    title = "SC: Principal Component Analysis",
    x = paste0("PC1 (", SC_var_explained[1], "% variance)"),
    y = paste0("PC2 (", SC_var_explained[2], "% variance)")
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "right"
  )
dev.off()

# ===== DORSAL ROOT GANGLIA =====

# Sample correlation heatmap
DRG_sample_cor <- cor(DRGlog_fpkm_filtered, method = "pearson")

save_png("DRG_sample_correlation.png")
pheatmap(
  DRG_sample_cor,
  color = colorRampPalette(rev(brewer.pal(11, "RdBu")))(100),
  annotation_col = DRGsample_condition,
  annotation_row = DRGsample_condition,
  annotation_colors = annotation_colors,
  display_numbers = TRUE,
  number_format = "%.2f",
  fontsize_number = 10,
  main = "DRG: Sample Correlation (Pearson)",
  clustering_distance_rows = "euclidean",
  clustering_distance_cols = "euclidean"
)
dev.off()

# PCA analysis
DRG_pca <- prcomp(t(DRGlog_fpkm_filtered), scale. = TRUE)
DRG_pca_data <- data.frame(
  PC1 = DRG_pca$x[,1],
  PC2 = DRG_pca$x[,2],
  condition = DRGsample_condition$condition,
  Sample = rownames(DRG_pca$x)
)

# Calculate variance explained
DRG_var_explained <- round(100 * DRG_pca$sdev^2 / sum(DRG_pca$sdev^2), 1)

# PCA plot
save_png("DRG_PCA.png")
ggplot(DRG_pca_data, aes(x = PC1, y = PC2, color = condition, label = Sample)) +
  geom_point(size = 4) +
  geom_text(vjust = -1, size = 3) +
  scale_color_manual(values = annotation_colors$condition) +
  labs(
    title = "DRG: Principal Component Analysis",
    x = paste0("PC1 (", DRG_var_explained[1], "% variance)"),
    y = paste0("PC2 (", DRG_var_explained[2], "% variance)")
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "right"
  )
dev.off()

# ============================================================
# INTERPRETATION GUIDELINES
# ============================================================

cat("\n=== QC Interpretation Guidelines ===\n")
cat("CORRELATION HEATMAP:\n")
cat("  - Biological replicates should correlate > 0.90\n")
cat("  - Within-group correlations should be higher than between-group\n")
cat("  - Values < 0.85 may indicate outliers\n\n")
cat("PCA PLOT:\n")
cat("  - Samples should cluster by condition (sham vs SNL)\n")
cat("  - Tight clustering within groups = good reproducibility\n")
cat("  - Outliers appear far from their group\n")
cat("  - PC1 should ideally separate conditions\n")


```

#### Analyzing pathways of interest

```{r}

master_gene_lists <- load_master_gene_lists()

# Extract pathway-specific results for SC
## ANTIOXIDANT PATHWAY
SC_nrf2_stats <- extract_genes_from_results(SCresults, 
                                            master_gene_lists$all_nrf2, 
                                            "SC: All Nrf2")
SC_nrf2_sig_genes <- rownames(SC_nrf2_stats[SC_nrf2_stats$adj.P.Val < 0.05, ])

## INFLAMMATORY PATHWAY
SC_inflammation_stats <- extract_genes_from_results(SCresults, 
                                                    master_gene_lists$all_inflammation, 
                                                    "SC: All Inflammation")
SC_inflammation_sig_genes <- rownames(SC_inflammation_stats[SC_inflammation_stats$adj.P.Val < 0.05, ])

# Extract pathway-specific results for DRG
## ANTIOXIDANT PATHWAY
DRG_nrf2_stats <- extract_genes_from_results(DRGresults,
                                             master_gene_lists$all_nrf2, 
                                             "DRG: All Nrf2")
DRG_nrf2_sig_genes <- rownames(DRG_nrf2_stats[DRG_nrf2_stats$adj.P.Val < 0.05, ])

## INFLAMMATORY PATHWAY
DRG_inflammation_stats <- extract_genes_from_results(DRGresults, 
                                                     master_gene_lists$all_inflammation,
                                                     "DRG: All Inflammation")
DRG_inflammation_sig_genes <- rownames(DRG_inflammation_stats[DRG_inflammation_stats$adj.P.Val < 0.05, ])
```

#### Visualization

```{r Antiox_significant}

### ========== ANTIOXIDANT PATHWAY ========== 

## ==== SPINAL CORD ===
# Extract expression data for significant Nrf2 genes
SC_nrf2_expr <- SClog_fpkm_filtered[SC_nrf2_sig_genes, ]

# Calculate Z-scores (scale by row)
SC_nrf2_zscores <- t(scale(t(SC_nrf2_expr)))

# Create annotation for samples
SC_annotation <- data.frame(
  Condition = c("Sham", "Sham", "Sham", "SNL", "SNL", "SNL"),
  row.names = colnames(SC_nrf2_zscores)
)

# Create heatmap
save_png("SC_Nrf2_heatmap.png")
pheatmap(
  SC_nrf2_zscores,
  color = colorRampPalette(rev(brewer.pal(11, "PiYG")))(100),
  annotation_col = SC_annotation,
  annotation_colors = annotation_colors,
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  main = "SC: Significant Nrf2 Pathway Genes (Z-scores)",
  fontsize_row = 10
)
dev.off()


# === DORSAL ROOT GANGLIA ===

# Extract expression data for these genes
DRG_nrf2_expr <- DRGlog_fpkm_filtered[DRG_nrf2_sig_genes, ]

# Calculate Z-scores (scale by row)
DRG_nrf2_zscores <- t(scale(t(DRG_nrf2_expr)))

# Create annotation for samples
DRG_annotation <- data.frame(
  Condition = c("Sham", "Sham", "Sham", "SNL", "SNL", "SNL"),
  row.names = colnames(DRG_nrf2_zscores)
)

# Create heatmap
save_png("DRG_Nrf2_heatmap.png")
pheatmap(
  DRG_nrf2_zscores,
  color = colorRampPalette(rev(brewer.pal(11, "PiYG")))(100),
  annotation_col = DRG_annotation,
  annotation_colors = annotation_colors,
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  main = "DRG: Significant Nrf2 Pathway Genes (Z-scores)",
  fontsize_row = 10
)
dev.off()

```

```{r Inflammatory_significant}
### ========== INFLAMMATORY PATHWAY ========== 

## ==== SPINAL CORD ===
# Extract expression data for significant Nrf2 genes
SC_inflammation_expr <- SClog_fpkm_filtered[SC_inflammation_sig_genes, ]

# Calculate Z-scores (scale by row)
SC_inflammation_zscores <- t(scale(t(SC_inflammation_expr)))

# Create annotation for samples
SC_inflammation_annotation <- data.frame(
  Condition = c("Sham", "Sham", "Sham", "SNL", "SNL", "SNL"),
  row.names = colnames(SC_inflammation_zscores)
)

# Create heatmap
save_png("SC_Inflammation_heatmap.png")
pheatmap(
  SC_inflammation_zscores,
  color = colorRampPalette(rev(brewer.pal(11, "PiYG")))(100),
  annotation_col = SC_inflammation_annotation,
  annotation_colors = annotation_colors,
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  main = "SC: Significant Inflammatory Pathway Genes (Z-scores)",
  fontsize_row = 10
)
dev.off()


# === DORSAL ROOT GANGLIA ===

# Extract expression data for these genes
DRG_inflammation_expr <- DRGlog_fpkm_filtered[DRG_inflammation_sig_genes, ]

# Calculate Z-scores (scale by row)
DRG_inflammation_zscores <- t(scale(t(DRG_inflammation_expr)))

# Create annotation for samples
DRG_inflammation_annotation <- data.frame(
  Condition = c("Sham", "Sham", "Sham", "SNL", "SNL", "SNL"),
  row.names = colnames(DRG_inflammation_zscores)
)

# Create heatmap
save_png("DRG_Inflammation_heatmap.png")
pheatmap(
  DRG_inflammation_zscores,
  color = colorRampPalette(rev(brewer.pal(11, "PiYG")))(100),
  annotation_col = DRG_inflammation_annotation,
  annotation_colors = annotation_colors,
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  show_rownames = TRUE,
  show_colnames = TRUE,
  main = "DRG: Significant Nrf2 Pathway Genes (Z-scores)",
  fontsize_row = 10
)
dev.off()


```
